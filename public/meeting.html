<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="description" content="ERIX Studios Video Conferencing" />
  <title>ERIX STUDIOS - Meeting Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
    crossorigin="anonymous" />
  <style>
    /* Base styles for all devices */
    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    /* Video Grid Layout */
    #video-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      overflow-y: auto;
      padding: 0.5rem;
      height: 100%;
      width: 100%;
    }

    .video-main {
      flex: 1;
      max-height: 70vh;
      /* Adjust based on preference */
      width: 100%;
      background-color: #1a202c;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 16/9;
      position: relative;
      cursor: pointer;
    }

    .video-secondary-container {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      overflow-x: auto;
      max-height: 20vh;
      /* Adjust to fit secondary videos */
      width: 100%;
      padding: 0.5rem 0;
    }



    .participant-tile {
      width: 150px;
      /* Fixed width for secondary videos */
      min-width: 150px;
      background-color: #1a202c;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 16/9;
      position: relative;
      cursor: pointer;
    }

    .video-container video,
    .participant-tile video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border: black solid 1px;
    }

    .camera-video {
      transform: scaleX(-1);
    }

    /* Hide secondary container if only one participant */
    #video-grid:has(> .video-main:only-child) .video-secondary-container {
      display: none;
    }

    /* Desktop-specific styles */
    @media (min-width: 1025px) {
      #video-grid {
        flex-direction: row;
        width: 100vw;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }

      .video-main {
        flex: 3;
        max-width: 70vw;
        max-height: 80vh;
      }

      .video-secondary-container {
        flex: 1;
        flex-direction: column;
        flex-wrap: wrap;
        overflow-y: auto;
        overflow-x: wrap;
        width: 200px;
        margin-right: 15px;
        max-height: 100vh;
        padding: 0.5rem;
        gap: 1rem;
        justify-content: space-between;
      }

      .video-secondary-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      .participant-tile {
        width: 100%;
        max-width: 200px;
         max-height: 120px;
      }
    }

    /* Tablet-specific styles */
    @media (min-width: 641px) and (max-width: 1024px) {
      .video-main {
        max-height: 60vh;
      }

      .video-secondary-container {
        max-height: 15vh;
      }

      .participant-tile {
        width: 120px;
        min-width: 120px;
      }
    }

    /* Mobile-specific styles */
    @media (max-width: 640px) {
      .video-main {
        max-height: 50vh;
      }

      .video-secondary-container {
        max-height: 12vh;
      }

      .participant-tile {
        width: 100px;
        min-width: 100px;
      }
    }

    /* Scrollbar styling for secondary container */
    .video-secondary-container::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .video-secondary-container::-webkit-scrollbar-thumb {
      background-color: #4a5568;
      border-radius: 3px;
    }

    .video-secondary-container::-webkit-scrollbar-track {
      background-color: #2d3748;
    }

    /* Participant name styling */
    .participant-name {
      position: absolute;
      bottom: 0.5rem;
      left: 0.5rem;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 12px;
      z-index: 2;
    }

    /* Participant controls styling */
    .participant-controls {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.25rem;
      z-index: 2;
    }

    .participant-controls button {
      font-size: 12px;
      padding: 0.3rem 0.5rem;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      border-radius: 4px;
    }

    /* Chat message animation */
    .chat-message {
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Screen share overlay */
    .screen-share-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .screen-share-video {
      width: 90%;
      height: 80%;
      max-height: 80vh;
      background-color: black;
      border-radius: 8px;
      overflow: hidden;
    }

    .screen-share-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Reaction animation */
    .reaction-animation {
      position: absolute;
      animation: floatUp 2s ease-in-out forwards;
      font-size: 24px;
      z-index: 10;
      pointer-events: none;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }

      100% {
        transform: translateY(-100px) scale(0.5);
        opacity: 0;
      }
    }

    /* Blur background for modals */
    .blur-background {
      filter: blur(5px);
    }

    /* Sidebar styling */
    .sidebar {
      transition: transform 0.3s ease-in-out;
      width: 80vw;
      max-width: 300px;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
    }

    .sidebar-hidden {
      transform: translateX(100%);
    }

    /* Home screen background */
    .home-screen {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    }

    /* Meeting card hover effect */
    .meeting-card {
      transition: all 0.3s ease;
    }

    .meeting-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    /* Floating button hover effect */
    .floating-button {
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .floating-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }

    /* Invite friends modal */
    .invite-friends-modal {
      animation: modalFadeIn 0.3s ease-out;
      width: 90%;
      max-width: 400px;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Background pattern */
    .background-pattern {
      background-image: radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    /* Pulse animation */
    .pulse-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      background-color: #9ca3af;
      border-radius: 50%;
      margin: 0 2px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingAnimation {

      0%,
      60%,
      100% {
        transform: translateY(0);
      }

      30% {
        transform: translateY(-5px);
      }
    }

    /* Logo text styling */
    .logo-text {
      font-family: "Arial", sans-serif;
      font-weight: 800;
      letter-spacing: 1px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-size: 20px;
    }

    /* Glow text effect */
    .glow-text {
      text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
    }

    /* Screen sharing badge */
    .screen-sharing-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: #10b981;
      color: white;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 10px;
      font-weight: medium;
      z-index: 2;
    }

    /* Participant screen sharing indicator */
    .participant-screen-sharing {
      display: inline-flex;
      align-items: center;
      background-color: #10b981;
      color: white;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      font-size: 10px;
      margin-left: 0.5rem;
    }

    /* Video wrapper for aspect ratio */
    .video-wrapper {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      /* 16:9 aspect ratio */
    }

    .video-wrapper video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Notification toast */
    #notification-toast {
      max-width: calc(100% - 2rem);
      word-break: break-word;
      z-index: 1000;
      transition: opacity 0.3s ease-in-out;
      opacity: 0;
    }

    #notification-toast:not(.hidden) {
      opacity: 1;
    }

    /* General utility classes */
    .fixed.bottom-20 {
      max-height: 50vh;
      overflow-y: auto;
    }

    button {
      touch-action: manipulation;
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Controls container */
    .controls-container {
      position: relative;
      z-index: 10;
    }

    /* Mobile-specific styles */
    @media (max-width: 640px) {
      .logo-text {
        font-size: 16px;
      }

      header {
        padding: 0.5rem !important;
      }

      header .flex.items-center.space-x-4 {
        flex-wrap: wrap;
        gap: 0.25rem;
      }

      #meeting-title {
        font-size: 0.75rem;
      }

      .flex.items-center.justify-between.mb-4 {
        margin-bottom: 0.5rem;
        padding: 0 0.5rem;
      }

      .flex.items-center.justify-between.mb-4>div {
        gap: 0.25rem;
      }

      .flex.items-center.justify-between.mb-4 span.text-sm {
        font-size: 0.65rem;
      }

      .flex.items-center.justify-between.mb-4 button.text-xs {
        font-size: 0.65rem;
        padding: 0.25rem 0.5rem;
      }

      .bg-gray-800.rounded-lg.p-3.mt-4 {
        padding: 0.5rem !important;
        margin-top: 0.25rem !important;
      }

      .bg-gray-800.rounded-lg.p-3.mt-4 button {
        padding: 0.4rem !important;
        min-width: 36px !important;
        min-height: 36px !important;
      }

      .sidebar {
        width: 90vw !important;
      }

      #sidebar-tabs button {
        font-size: 0.65rem;
        padding: 0.4rem;
      }

      #chat-input {
        font-size: 0.65rem;
      }

      #chat-messages {
        font-size: 0.65rem;
      }

      #participants-list {
        font-size: 0.65rem;
      }

      .invite-friends-modal {
        padding: 0.5rem;
      }

      .invite-friends-modal h2 {
        font-size: 0.875rem;
      }

      .invite-friends-modal input {
        font-size: 0.65rem;
      }

      #reactions-popup,
      #more-options-popup,
      #virtual-background-popup {
        bottom: 4rem !important;
        right: 0.25rem !important;
        left: 0.25rem !important;
        width: auto !important;
        font-size: 0.65rem;
      }

      #notification-toast {
        bottom: 1rem !important;
        right: 1rem !important;
        left: 1rem !important;
        font-size: 0.75rem;
        padding: 0.5rem 1rem;
        max-width: calc(100% - 2rem);
      }
    }

    /* Tablet-specific styles */
    @media (min-width: 641px) and (max-width: 1024px) {
      .sidebar {
        width: 50vw;
        max-width: 350px;
      }
    }
  </style>
</head>

<body class="bg-gray-900 text-white h-screen   flex-col">
  <!-- Meeting Screen -->
  <div id="meeting-screen" class="h-full flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="bg-gray-800 py-2 px-4 flex items-center justify-between border-b border-gray-700">
      <div class="flex items-center space-x-4">
        <div class="flex items-center cursor-pointer" id="home-button">
          <i class="fas fa-home text-blue-400 text-xl mr-2"></i>
          <h1 class="text-xl font-bold logo-text">ERIX STUDIOS</h1>
        </div>
        <div class="hidden md:flex items-center space-x-2">
          <span class="text-sm text-gray-300">Meeting ID:</span>
          <span class="font-mono bg-gray-700 px-2 py-1 rounded" id="meeting-id"></span>
          <button class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" id="copy-meeting-id">
            <i class="fas fa-copy mr-1"></i>Copy ID
          </button>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <button class="hidden md:flex items-center space-x-1 text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded"
          id="security-btn">
          <i class="fas fa-shield-alt text-green-400"></i>
          <span>Security</span>
        </button>
        <button class="hidden md:flex items-center space-x-1 text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded"
          id="settings-btn">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </button>
        <button class="md:flex items-center space-x-1 text-sm bg-red-500 hover:bg-red-600 px-3 py-1 rounded"
          id="end-call-btn">
          <i class="fas fa-phone-slash"></i>
          <span>End call</span>
        </button>
      </div>
    </header>

    <!-- Main Video Area -->
    <div class="flex-1 flex flex-col p-2 overflow-hidden">
      <!-- Meeting Info Bar -->
      <div class="flex items-center justify-between mb-2 px-2">
        <div class="flex items-center space-x-2">
          <span class="text-sm text-gray-300">Meeting:</span>
          <span class="font-medium text-sm" id="meeting-title">Creative Review</span>
          <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">Host</span>
        </div>
        <div class="flex items-center space-x-2">
          <button class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" id="participants-toggle">
            <i class="fas fa-user-friends mr-1"></i>
            <span id="participant-count">1</span>
          </button>
          <button class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" id="chat-toggle">
            <i class="fas fa-comment-alt mr-1"></i>
            <span>Chat</span>
          </button>
          <button class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" id="invite-button">
            <i class="fas fa-user-plus mr-1"></i>
            <span>Invite</span>
          </button>
        </div>
      </div>

      <!-- Video Grid -->
      <div class="flex-1 overflow-y-auto" id="video-grid">
        <!-- Videos will be inserted here -->
      </div>

      <!-- Controls Bar -->
      <div class="bg-gray-800 rounded-lg p-2 mt-2 flex items-center justify-between flex-wrap gap-2 controls-container">
        <div class="flex items-center space-x-2">
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="mic-toggle">
            <i class="fas fa-microphone text-green-400"></i>
          </button>
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="camera-toggle">
            <i class="fas fa-video text-green-400"></i>
          </button>
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gradient-to-r from-blue-500 to-purple-500"
            id="screen-share-btn">
            <i class="fas fa-desktop"></i>
          </button>
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="reactions-btn">
            <i class="far fa-smile"></i>
          </button>
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="virtual-background-btn">
            <i class="fas fa-image"></i>
          </button>
        </div>
        <div class="flex items-center space-x-2">
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="raise-hand-btn">
            <i class="fas fa-hand-paper"></i>
          </button>
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="record-btn">
            <i class="fas fa-circle text-gray-400"></i>
          </button>
          <button class="p-2 rounded-full bg-red-500 hover:bg-red-600" id="leave-call-btn">
            <i class="fas fa-phone-slash"></i>
          </button>
        </div>
        <div class="flex items-center space-x-2">
          <button class="p-2 rounded-full bg-gray-700 hover:bg-gray-600" id="more-options-btn">
            <i class="fas fa-ellipsis-h"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Sidebar (Participants/Chat) -->
    <div class="bg-gray-800 border-l border-gray-700 flex flex-col sidebar sidebar-hidden" id="sidebar">
      <div class="p-2 border-b border-gray-700 flex justify-between items-center">
        <div class="flex space-x-1" id="sidebar-tabs">
          <button class="px-2 py-1 rounded font-medium bg-gray-700 text-sm" data-tab="participants">
            <i class="fas fa-user-friends mr-1"></i>Participants
          </button>
          <button class="px-2 py-1 rounded font-medium text-sm" data-tab="chat">
            <i class="fas fa-comment-alt mr-1"></i>Chat
          </button>
        </div>
        <button class="p-1 rounded-full hover:bg-gray-700" id="close-sidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Participants Tab Content -->
      <div class="flex-1 overflow-y-auto p-2" id="participants-tab">
        <div class="mb-3">
          <div class="flex justify-between items-center mb-2">
            <h3 class="font-medium text-sm">
              In this call (<span id="participant-count-sidebar">1</span>)
            </h3>
            <button class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" id="search-participants">
              <i class="fas fa-search mr-1"></i>Search
            </button>
          </div>
          <div class="space-y-1" id="participants-list">
            <!-- Participants will be inserted here -->
          </div>
        </div>
        <div>
          <h3 class="font-medium text-sm mb-2">Invite people</h3>
          <div class="flex space-x-1">
            <input type="text" placeholder="Email or name"
              class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" id="invite-participant" />
            <button class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-sm" id="send-invite">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="mt-1">
            <button class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded" id="copy-meeting-link-sidebar">
              <i class="fas fa-link mr-1"></i>Copy meeting link
            </button>
          </div>
        </div>
      </div>

      <!-- Chat Tab Content -->
      <div class="flex-1 overflow-y-auto p-2 hidden" id="chat-tab">
        <div class="space-y-2 mb-2" id="chat-messages">
          <!-- Chat messages will be inserted here -->
        </div>
        <div class="mt-auto">
          <div class="flex space-x-1">
            <button class="p-1 rounded-full hover:bg-gray-700" id="attach-file-btn">
              <i class="fas fa-paperclip text-sm"></i>
            </button>
            <input type="text" placeholder="Type a message"
              class="flex-1 bg-gray-700 border border-gray-600 rounded-full px-3 py-1 text-sm" id="chat-input" />
            <button class="p-1 rounded-full hover:bg-gray-700" id="emoji-picker-btn">
              <i class="far fa-smile text-sm"></i>
            </button>
            <button class="p-1 rounded-full bg-blue-600 hover:bg-blue-700" id="send-message-btn">
              <i class="fas fa-paper-plane text-sm"></i>
            </button>
            <button class="p-1 rounded-full bg-gray-700 hover:bg-gray-600" id="send-reaction-btn">
              <i class="fas fa-heart text-red-400 text-sm"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Screen Share Overlay -->
  <div class="screen-share-overlay hidden" id="screen-share-overlay">
    <div class="screen-share-video">
      <video id="screen-share-video" autoplay playsinline></video>
    </div>
    <div class="mt-2 flex space-x-2">
      <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm" id="stop-screen-share">
        <i class="fas fa-stop mr-1"></i>Stop sharing
      </button>
      <button class="px-3 py-1 bg-gray-700 hover:bg-gray-600 rounded text-sm" id="minimize-screen-share">
        <i class="fas fa-window-minimize mr-1"></i>Minimize
      </button>
    </div>
  </div>

  <!-- Reactions Popup -->
  <div class="fixed bottom-20 right-2 bg-gray-800 rounded-lg shadow-lg p-2 hidden" id="reactions-popup">
    <div class="grid grid-cols-4 gap-1">
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="👍">
        <span class="text-lg">👍</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="👎">
        <span class="text-lg">👎</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="👏">
        <span class="text-lg">👏</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="😂">
        <span class="text-lg">😂</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="😮">
        <span class="text-lg">😮</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="😢">
        <span class="text-lg">😢</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="❤️">
        <span class="text-lg">❤️</span>
      </button>
      <button class="p-1 rounded-full hover:bg-gray-700 reaction-emoji" data-emoji="🎉">
        <span class="text-lg">🎉</span>
      </button>
    </div>
  </div>

  <!-- More Options Popup -->
  <div class="fixed bottom-20 right-2 bg-gray-800 rounded-lg shadow-lg p-2 hidden w-48" id="more-options-popup">
    <div class="space-y-1">
      <button class="w-full text-left px-2 py-1 hover:bg-gray-600 rounded flex items-center text-sm"
        id="settings-option">
        <i class="fas fa-cog mr-2 text-sm"></i> Settings
      </button>
      <button class="w-full text-left px-2 py-1 hover:bg-gray-600 rounded flex items-center text-sm"
        id="meeting-options">
        <i class="fas fa-user-shield mr-2 text-sm"></i> Meeting options
      </button>
      <button class="w-full text-left px-2 py-1 hover:bg-gray-600 rounded flex items-center text-sm"
        id="captions-option">
        <i class="fas fa-closed-captioning mr-2 text-sm"></i> Turn on captions
      </button>
      <button class="w-full text-left px-2 py-1 hover:bg-gray-600 rounded flex items-center text-sm"
        id="caption-language-option">
        <i class="fas fa-language mr-2 text-sm"></i> Caption language
      </button>
      <button class="w-full text-left px-2 py-1 hover:bg-gray-600 rounded flex items-center text-sm"
        id="language-option">
        <i class="fas fa-language mr-2 text-sm"></i> Language interpretation
      </button>
      <button class="w-full text-left px-2 py-1 hover:bg-gray-600 rounded flex items-center text-sm"
        id="fullscreen-option">
        <i class="fas fa-expand mr-2 text-sm"></i> Full screen
      </button>
    </div>
  </div>
  <!-- Virtual Background Popup -->
  <div class="fixed bottom-20 left-2 bg-gray-800 rounded-lg shadow-lg p-2 hidden w-64" id="virtual-background-popup">
    <h3 class="font-medium text-sm mb-2">Virtual Background</h3>
    <div class="grid grid-cols-3 gap-1 mb-2">
      <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center" data-background="none">
        <div class="w-10 h-10 bg-gray-600 rounded mb-1"></div>
        <span class="text-xs">None</span>
      </button>
      <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center" data-background="blur">
        <div class="w-10 h-10 bg-blue-600 rounded mb-1"></div>
        <span class="text-xs">Blur</span>
      </button>
      <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center" data-background="office">
        <div class="w-10 h-10 bg-green-600 rounded mb-1"></div>
        <span class="text-xs">Office</span>
      </button>
      <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center" data-background="beach">
        <div class="w-10 h-10 bg-purple-600 rounded mb-1"></div>
        <span class="text-xs">Beach</span>
      </button>
      <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center" data-background="mountains">
        <div class="w-10 h-10 bg-yellow-600 rounded mb-1"></div>
        <span class="text-xs">Mountains</span>
      </button>
      <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center" data-background="space">
        <div class="w-10 h-10 bg-red-600 rounded mb-1"></div>
        <span class="text-xs">Space</span>
      </button>
    </div>
    <button class="w-full text-left px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-xs" id="add-background-image">
      <i class="fas fa-plus mr-2"></i> Add Image
    </button>
  </div>

  <!-- Invite Friends Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden"
    id="invite-friends-modal">
    <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md invite-friends-modal">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold">Invite Friends</h2>
        <button class="text-gray-400 hover:text-white" id="close-invite-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Meeting Link</label>
        <div class="flex">
          <input type="text" class="flex-1 bg-gray-700 border border-gray-600 rounded-l px-2 py-1 text-sm" readonly
            id="meeting-link" />
          <button class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded-r text-sm" id="copy-meeting-link">
            <i class="fas fa-copy"></i>
          </button>
        </div>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Invite via Email</label>
        <div class="flex space-x-1">
          <input type="email" placeholder="Enter email addresses"
            class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" id="invite-emails" multiple />
          <button class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-sm" id="send-invites">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-1">
          Separate multiple emails with commas
        </p>
      </div>

      <div>
        <h3 class="text-sm font-medium mb-1">Quick Share</h3>
        <div class="grid grid-cols-4 gap-1">
          <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center justify-center text-xs"
            id="share-whatsapp">
            <i class="fab fa-whatsapp text-green-400 text-base mb-1"></i>
            WhatsApp
          </button>
          <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center justify-center text-xs"
            id="share-email">
            <i class="fas fa-envelope text-blue-400 text-base mb-1"></i>
            Email
          </button>
          <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center justify-center text-xs"
            id="share-sms">
            <i class="fas fa-sms text-yellow-400 text-base mb-1"></i>
            SMS
          </button>
          <button class="p-1 bg-gray-700 hover:bg-gray-600 rounded flex flex-col items-center justify-center text-xs"
            id="share-copy">
            <i class="fas fa-copy text-gray-400 text-base mb-1"></i>
            Copy
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Username Input Modal -->
  <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden" id="username-modal">
    <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md username-modal">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold">Enter Your Name</h2>
        <button class="text-gray-400 hover:text-white" id="close-username-modal">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Your Name</label>
        <div class="flex space-x-1">
          <input type="text" placeholder="Enter your name"
            class="flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" id="username-input" required />
          <button class="bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded text-sm" id="submit-username">
            <i class="fas fa-check"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div
    class="fixed bottom-4 right-4 bg-gray-800 text-white px-3 py-1 rounded-lg shadow-lg text-sm hidden flex items-center"
    id="notification-toast" data-notification="toast">
    <i class="fas fa-check-circle text-green-400 mr-2"></i>
    <span id="notification-message"></span>
  </div>


  <script src="/meet/socket.io/socket.io.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>

    const path = window.location.pathname.startsWith('/meet/')
      ? '/meet/socket.io'
      : '/socket.io';  
    // Initialize Socket.IO with reconnection handling
    const socket = io({
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
            path: path,
      reconnectionDelayMax: 5000,
      randomizationFactor: 0.5,
    });

    // URL Parameters
    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get("room")?.trim();
    let userName = sessionStorage.getItem("userName")?.trim();

    // DOM Elements
    const elements = {
      meetingScreen: document.getElementById("meeting-screen"),
      homeButton: document.getElementById("home-button"),
      meetingIdDisplay: document.getElementById("meeting-id"),
      copyMeetingId: document.getElementById("copy-meeting-id"),
      meetingTitle: document.getElementById("meeting-title"),
      videoGrid: document.getElementById("video-grid"),
      micToggle: document.getElementById("mic-toggle"),
      cameraToggle: document.getElementById("camera-toggle"),
      screenShareBtn: document.getElementById("screen-share-btn"),
      raiseHandBtn: document.getElementById("raise-hand-btn"),
      recordBtn: document.getElementById("record-btn"),
      leaveCallBtn: document.getElementById("leave-call-btn"),
      endCallBtn: document.getElementById("end-call-btn"),
      moreOptionsBtn: document.getElementById("more-options-btn"),
      reactionsBtn: document.getElementById("reactions-btn"),
      virtualBackgroundBtn: document.getElementById("virtual-background-btn"),
      sidebar: document.getElementById("sidebar"),
      closeSidebarBtn: document.getElementById("close-sidebar"),
      participantsToggle: document.getElementById("participants-toggle"),
      chatToggle: document.getElementById("chat-toggle"),
      inviteButton: document.getElementById("invite-button"),
      sidebarTabs: document.getElementById("sidebar-tabs"),
      participantsTab: document.getElementById("participants-tab"),
      chatTab: document.getElementById("chat-tab"),
      participantsList: document.getElementById("participants-list"),
      participantCount: document.getElementById("participant-count"),
      participantCountSidebar: document.getElementById("participant-count-sidebar"),
      inviteParticipant: document.getElementById("invite-participant"),
      sendInvite: document.getElementById("send-invite"),
      copyMeetingLinkSidebar: document.getElementById("copy-meeting-link-sidebar"),
      chatInput: document.getElementById("chat-input"),
      sendMessageBtn: document.getElementById("send-message-btn"),
      sendReactionBtn: document.getElementById("send-reaction-btn"),
      chatMessages: document.getElementById("chat-messages"),
      screenShareOverlay: document.getElementById("screen-share-overlay"),
      stopScreenShareBtn: document.getElementById("stop-screen-share"),
      minimizeScreenShareBtn: document.getElementById("minimize-screen-share"),
      reactionsPopup: document.getElementById("reactions-popup"),
      moreOptionsPopup: document.getElementById("more-options-popup"),
      virtualBackgroundPopup: document.getElementById("virtual-background-popup"),
      inviteFriendsModal: document.getElementById("invite-friends-modal"),
      closeInviteModal: document.getElementById("close-invite-modal"),
      meetingLink: document.getElementById("meeting-link"),
      copyMeetingLink: document.getElementById("copy-meeting-link"),
      sendInvitesBtn: document.getElementById("send-invites"),
      inviteEmails: document.getElementById("invite-emails"),
      shareWhatsapp: document.getElementById("share-whatsapp"),
      shareEmail: document.getElementById("share-email"),
      shareSms: document.getElementById("share-sms"),
      shareCopy: document.getElementById("share-copy"),
      notificationToast: document.getElementById("notification-toast"),
      notificationMessage: document.getElementById("notification-message"),
      usernameModal: document.getElementById("username-modal"),
      closeUsernameModal: document.getElementById("close-username-modal"),
      usernameInput: document.getElementById("username-input"),
      submitUsername: document.getElementById("submit-username"),
    };

    // State Management
    const state = {
      localStream: null,
      screenStream: null,
      isMicOn: true,
      isCameraOn: true,
      isScreenSharing: false,
      isHandRaised: false,
      isRecording: false,
      isSidebarOpen: false,
      activeTab: "participants",
      isHost: false,
      peers: new Map(),
      peerStreams: new Map(),
      participantNames: new Map(),
      cleanupInterval: null,
      focusedParticipant: "local",
      screenSharingParticipant: null,
      micStream: null,
      isCaptionsOn: false,
      recognition: null,
      captionLanguage: "en-US", // New: default caption language
      meetingOptions: {
        lockMeeting: false,
        muteOnJoin: true,
        videoOffOnJoin: false,
      },
      chatMessages: [],
      typingUsers: new Set(),
    };

    // WebRTC Configuration
    const config = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        { urls: "stun:stun1.l.google.com:19302" },
        { urls: "stun:stun2.l.google.com:19302" },
      ],
      iceTransportPolicy: "all",
      iceCandidatePoolSize: 0,
    };

    // Initialize Application
    function init() {
      if (!room) {
        showNotification("Invalid meeting room");
        setTimeout(() => (window.location.href = "/"), 2000);
        return;
      }

      if (!userName) {
        showUsernameModal();
      } else {
        state.participantNames.set("local", sanitizeInput(userName));
        setupMeeting();
      }

      elements.submitUsername.addEventListener("click", handleUsernameSubmit);
      elements.usernameInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleUsernameSubmit();
      });
      elements.closeUsernameModal.addEventListener("click", () => {
        window.location.href = "/";
      });

      window.addEventListener("beforeunload", cleanup);
    }

    // Input Sanitization
    function sanitizeInput(input) {
      const div = document.createElement("div");
      div.textContent = input || "";
      return div.innerHTML.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // Show Username Modal
    function showUsernameModal() {
      elements.usernameModal.classList.remove("hidden");
      elements.meetingScreen.classList.add("blur-background");
      elements.usernameInput.focus();
    }

    // Handle Username Submission
    function handleUsernameSubmit() {
      const name = elements.usernameInput.value.trim();
      if (name && name.length <= 50) {
        userName = sanitizeInput(name);
        sessionStorage.setItem("userName", userName);
        state.participantNames.set("local", userName);
        elements.usernameModal.classList.add("hidden");
        elements.meetingScreen.classList.remove("blur-background");
        updateMeetingLink();
        setupMeeting();
      } else {
        showNotification("Please enter a valid name (1-50 characters)");
      }
    }

    // Setup Meeting
    function setupMeeting() {
      elements.meetingIdDisplay.textContent = room;
      elements.meetingTitle.textContent = "Creative Review";
      updateMeetingLink();

      // Event Listeners
      elements.homeButton.addEventListener("click", returnToHomeScreen);
      elements.copyMeetingId.addEventListener("click", copyMeetingLinkToClipboard);
      elements.micToggle.addEventListener("click", toggleMic);
      elements.cameraToggle.addEventListener("click", toggleCamera);
      elements.screenShareBtn.addEventListener("click", toggleScreenShare);
      elements.raiseHandBtn.addEventListener("click", toggleRaiseHand);
      elements.recordBtn.addEventListener("click", toggleRecording);
      elements.leaveCallBtn.addEventListener("click", leaveCall);
      elements.endCallBtn.addEventListener("click", endCall);
      elements.moreOptionsBtn.addEventListener("click", toggleMoreOptions);
      elements.reactionsBtn.addEventListener("click", toggleReactionsPopup);
      elements.virtualBackgroundBtn.addEventListener("click", toggleVirtualBackgroundPopup);
      elements.closeSidebarBtn.addEventListener("click", toggleSidebar);
      elements.participantsToggle.addEventListener("click", () => {
        toggleSidebar();
        showTab("participants");
      });
      elements.chatToggle.addEventListener("click", () => {
        toggleSidebar();
        showTab("chat");
      });
      elements.inviteButton.addEventListener("click", showInviteFriendsModal);
      elements.copyMeetingLinkSidebar.addEventListener("click", copyMeetingLinkToClipboard);
      elements.sendInvite.addEventListener("click", sendEmailInvites);
      elements.closeInviteModal.addEventListener("click", hideInviteFriendsModal);
      elements.copyMeetingLink.addEventListener("click", copyMeetingLinkToClipboard);
      elements.sendInvitesBtn.addEventListener("click", sendEmailInvites);
      elements.shareWhatsapp.addEventListener("click", shareViaWhatsapp);
      elements.shareEmail.addEventListener("click", shareViaEmail);
      elements.shareSms.addEventListener("click", shareViaSms);
      elements.shareCopy.addEventListener("click", copyMeetingLinkToClipboard);

      elements.sidebarTabs.querySelectorAll("button").forEach((button) => {
        button.addEventListener("click", () => {
          showTab(button.getAttribute("data-tab"));
        });
      });

      elements.stopScreenShareBtn.addEventListener("click", stopScreenShare);
      elements.minimizeScreenShareBtn.addEventListener("click", () => {
        elements.screenShareOverlay.classList.add("hidden");
      });

      document.querySelectorAll(".reaction-emoji").forEach((button) => {
        button.addEventListener("click", () => {
          const emoji = button.getAttribute("data-emoji");
          sendReaction(emoji);
          elements.reactionsPopup.classList.add("hidden");
        });
      });

      // Close popups on outside click
      document.addEventListener("click", (e) => {
        if (
          !elements.moreOptionsBtn.contains(e.target) &&
          !elements.moreOptionsPopup.contains(e.target)
        ) {
          elements.moreOptionsPopup.classList.add("hidden");
        }
        if (
          !elements.reactionsBtn.contains(e.target) &&
          !elements.reactionsPopup.contains(e.target)
        ) {
          elements.reactionsPopup.classList.add("hidden");
        }
        if (
          !elements.virtualBackgroundBtn.contains(e.target) &&
          !elements.virtualBackgroundPopup.contains(e.target)
        ) {
          elements.virtualBackgroundPopup.classList.add("hidden");
        }
      });

      // Chat-specific event listeners
      elements.chatInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendChatMessage();
        }
      });
      elements.sendMessageBtn.addEventListener("click", sendChatMessage);
      elements.sendReactionBtn.addEventListener("click", () => sendReaction("❤️"));

      // Typing indicator
      let typingTimeout = null;
      elements.chatInput.addEventListener("input", () => {
        if (!typingTimeout) {
          socket.emit("typing", { room, name: userName });
          typingTimeout = setTimeout(() => {
            socket.emit("stop-typing", { room, name: userName });
            typingTimeout = null;
          }, 2000);
        }
      });

      setupMoreOptions();
      state.cleanupInterval = setInterval(cleanupStaleVideos, 2000);
      startMeeting();
    }

    // Update Meeting Link
    function updateMeetingLink() {
      const link = `${window.location.origin}/meeting.html?room=${encodeURIComponent(room)}`;
      elements.meetingLink.value = link;
    }

    // Start Meeting
    async function startMeeting() {
      try {
        await startLocalMedia();
        socket.emit("join-room", { room, name: userName });

        // Check with server to determine if this user is the host
        socket.emit("check-host", { room }, (response) => {
          state.isHost = response.isHost;
          if (state.isHost) {
            elements.endCallBtn.classList.remove("hidden"); // Ensure host sees the "End call" button
          }
        });

        if (state.meetingOptions.muteOnJoin) {
          state.isMicOn = false;
          if (state.localStream) {
            state.localStream.getAudioTracks().forEach((track) => {
              track.enabled = false;
            });
          }
          elements.micToggle.innerHTML = `<i class="fas fa-microphone-slash"></i>`;
        }
        if (state.meetingOptions.videoOffOnJoin) {
          state.isCameraOn = false;
          if (state.localStream) {
            state.localStream.getVideoTracks().forEach((track) => {
              track.enabled = false;
            });
          }
          elements.cameraToggle.innerHTML = `<i class="fas fa-video-slash"></i>`;
        }

        socket.emit("get-meeting-options", { room });
        createVideoElement("local", userName, state.localStream, true);
        addParticipant("local", userName, state.isHost, false);
        setupSocketEvents();
      } catch (error) {
        showNotification(`Failed to start meeting: ${error.message}`);
        setTimeout(() => (window.location.href = "/"), 3000);
      }
    }

    // Start Local Media
    async function startLocalMedia() {
      try {
        state.localStream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 1280 },
            height: { ideal: 720 },
            frameRate: { ideal: 30 },
          },
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 48000,
            channelCount: 2,
          },
        });
        state.micStream = new MediaStream(state.localStream.getAudioTracks());
      } catch (err) {
        try {
          state.localStream = await navigator.mediaDevices.getUserMedia({
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
              frameRate: { ideal: 30 },
            },
            audio: false,
          });
          state.micStream = null;
          showNotification("Microphone access denied; proceeding with video only");
        } catch (videoErr) {
          showNotification(`Could not access media devices: ${videoErr.message}`);
          throw videoErr;
        }
      }
    }

    // Combine Audio Streams
    function combineAudioStreams(micStream, systemStream) {
      if (!micStream && !systemStream) return null;
      if (!micStream) return systemStream;
      if (!systemStream) return micStream;

      const audioContext = new AudioContext();
      const destination = audioContext.createMediaStreamDestination();

      if (micStream.getAudioTracks().length > 0) {
        const micSource = audioContext.createMediaStreamSource(micStream);
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 0.8;
        micSource.connect(gainNode);
        gainNode.connect(destination);
      }

      if (systemStream.getAudioTracks().length > 0) {
        const systemSource = audioContext.createMediaStreamSource(systemStream);
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 1.0;
        systemSource.connect(gainNode);
        gainNode.connect(destination);
      }

      return destination.stream;
    }

    // Create Video Element
    function createVideoElement(participantId, name, stream, isLocal = false, isScreenSharing = false) {
      const existingContainer = document.getElementById(`video-container-${participantId}`);
      const isSharing = isScreenSharing || state.screenSharingParticipant === participantId;

      if (existingContainer) {
        const video = existingContainer.querySelector("video");
        const nameLabel = existingContainer.querySelector(".participant-name");
        const oldBadge = existingContainer.querySelector(".screen-sharing-badge");

        if (video && stream) {
          video.srcObject = stream;
          video.classList.toggle("camera-video", !isSharing);
          video.muted = isLocal;
          video.play().catch((err) => console.error(`Video play failed for ${participantId}:`, err));
        }

        if (nameLabel) {
          nameLabel.textContent = sanitizeInput(name);
        }

        if (oldBadge) oldBadge.remove();

        if (isSharing) {
          const screenShareBadge = document.createElement("div");
          screenShareBadge.className = "screen-sharing-badge";
          screenShareBadge.textContent = "Screen Sharing";
          existingContainer.appendChild(screenShareBadge);

          if (isLocal) {
            elements.screenShareOverlay.classList.remove("hidden");
            const screenShareVideo = elements.screenShareOverlay.querySelector("video");
            screenShareVideo.srcObject = stream;
            screenShareVideo.classList.remove("camera-video");
            screenShareVideo.muted = true;
            screenShareVideo.play().catch((err) => console.error("Screen share video play failed:", err));
          }
        } else {
          elements.screenShareOverlay.classList.add("hidden");
        }

        existingContainer.className = state.focusedParticipant === participantId ? "video-main" : "participant-tile";
        updateVideoGridLayout();
        return;
      }

      const videoContainer = document.createElement("div");
      videoContainer.id = `video-container-${participantId}`;
      videoContainer.className = state.focusedParticipant === participantId ? "video-main" : "participant-tile";

      const videoWrapper = document.createElement("div");
      videoWrapper.className = "video-wrapper";

      const video = document.createElement("video");
      video.id = `video-${participantId}`;
      video.autoplay = true;
      video.playsInline = true;
      video.muted = isLocal;
      video.className = isSharing ? "" : "camera-video";
      if (stream) {
        video.srcObject = stream;
        video.play().catch((err) => console.error(`Video play failed for ${participantId}:`, err));
      }

      const nameLabel = document.createElement("div");
      nameLabel.className = "participant-name";
      nameLabel.textContent = sanitizeInput(name);

      const controls = document.createElement("div");
      controls.className = "participant-controls";

      if (!isLocal) {
        const muteBtn = document.createElement("button");
        muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
        muteBtn.addEventListener("click", () => toggleRemoteMute(participantId));

        const videoBtn = document.createElement("button");
        videoBtn.innerHTML = '<i class="fas fa-video"></i>';
        videoBtn.addEventListener("click", () => toggleRemoteVideo(participantId));

        controls.appendChild(muteBtn);
        controls.appendChild(videoBtn);
      }

      if (isSharing) {
        const screenShareBadge = document.createElement("div");
        screenShareBadge.className = "screen-sharing-badge";
        screenShareBadge.textContent = "Screen Sharing";
        videoContainer.appendChild(screenShareBadge);

        if (!isLocal) {
          elements.screenShareOverlay.classList.remove("hidden");
          const screenShareVideo = elements.screenShareOverlay.querySelector("video");
          screenShareVideo.srcObject = stream;
          screenShareVideo.classList.remove("camera-video");
          screenShareVideo.muted = false;
          screenShareVideo.play().catch((err) => console.error("Screen share video play failed:", err));
        } else {
          const screenShareVideo = elements.screenShareOverlay.querySelector("video");
          screenShareVideo.muted = true;
        }
      }

      videoWrapper.appendChild(video);
      videoContainer.appendChild(videoWrapper);
      videoContainer.appendChild(nameLabel);
      videoContainer.appendChild(controls);

      videoContainer.addEventListener("click", () => setMainVideo(participantId));

      if (state.focusedParticipant === participantId) {
        elements.videoGrid.insertBefore(videoContainer, elements.videoGrid.firstChild);
      } else {
        let secondaryContainer = elements.videoGrid.querySelector(".video-secondary-container");
        if (!secondaryContainer) {
          secondaryContainer = document.createElement("div");
          secondaryContainer.className = "video-secondary-container";
          elements.videoGrid.appendChild(secondaryContainer);
        }
        secondaryContainer.appendChild(videoContainer);
      }

      updateVideoGridLayout();
    }

    // Update Video Grid Layout
    function updateVideoGridLayout() {
      const videoContainers = elements.videoGrid.querySelectorAll('[id^="video-container-"]');
      let secondaryContainer = elements.videoGrid.querySelector(".video-secondary-container");

      if (videoContainers.length > 1 && !secondaryContainer) {
        secondaryContainer = document.createElement("div");
        secondaryContainer.className = "video-secondary-container";
        elements.videoGrid.appendChild(secondaryContainer);
      }

      const mainContainer = document.getElementById(`video-container-${state.focusedParticipant}`);
      if (mainContainer && mainContainer.className !== "video-main") {
        mainContainer.className = "video-main";
        elements.videoGrid.insertBefore(mainContainer, elements.videoGrid.firstChild);
      }

      videoContainers.forEach((container) => {
        const id = container.id.replace("video-container-", "");
        if (id !== state.focusedParticipant) {
          container.className = "participant-tile";
          if (secondaryContainer && !secondaryContainer.contains(container)) {
            secondaryContainer.appendChild(container);
          }
        }
      });

      if (videoContainers.length <= 1 && secondaryContainer) {
        secondaryContainer.style.display = "none";
      } else if (secondaryContainer) {
        secondaryContainer.style.display = "flex";
      }
    }

    // Set Main Video
    function setMainVideo(participantId) {
      if (state.focusedParticipant === participantId) return;

      const oldMainContainer = elements.videoGrid.querySelector(`#video-container-${state.focusedParticipant}`);
      const newMainContainer = elements.videoGrid.querySelector(`#video-container-${participantId}`);

      if (!newMainContainer) return;

      state.focusedParticipant = participantId;

      if (oldMainContainer) {
        oldMainContainer.className = "participant-tile";
      }
      newMainContainer.className = "video-main";

      elements.videoGrid.insertBefore(newMainContainer, elements.videoGrid.firstChild);

      if (oldMainContainer) {
        let secondaryContainer = elements.videoGrid.querySelector(".video-secondary-container");
        if (!secondaryContainer) {
          secondaryContainer = document.createElement("div");
          secondaryContainer.className = "video-secondary-container";
          elements.videoGrid.appendChild(secondaryContainer);
        }
        secondaryContainer.appendChild(oldMainContainer);
      }

      updateVideoGridLayout();
    }

    // Add Participant
    function addParticipant(id, name, isHost = false, isHandRaised = false, isScreenSharing = false) {
      state.participantNames.set(id, sanitizeInput(name || "Anonymous"));
      const existingParticipant = elements.participantsList.querySelector(`[data-id="${id}"]`);
      if (existingParticipant) {
        const infoDiv = existingParticipant.querySelector(".flex.items-center.space-x-2");
        infoDiv.querySelector("span.font-medium").textContent = name;
        const screenShareIndicator = existingParticipant.querySelector(".participant-screen-sharing");
        if (screenShareIndicator) screenShareIndicator.remove();
        const handBadge = existingParticipant.querySelector(".hand-raised-badge");
        if (handBadge) handBadge.remove();
        const hostBadge = existingParticipant.querySelector(".host-badge");
        if (hostBadge) hostBadge.remove();

        if (isScreenSharing || state.screenSharingParticipant === id) {
          const indicator = document.createElement("span");
          indicator.className = "participant-screen-sharing text-xs bg-green-500 text-white px-1 rounded";
          indicator.textContent = "Screen Sharing";
          infoDiv.appendChild(indicator);
        }
        if (isHandRaised) {
          const handBadge = document.createElement("span");
          handBadge.className = "hand-raised-badge text-xs bg-yellow-500 text-yellow-900 px-1 rounded";
          handBadge.textContent = "Hand raised";
          infoDiv.appendChild(handBadge);
        }
        if (isHost) {
          const hostBadge = document.createElement("span");
          hostBadge.className = "host-badge text-xs bg-blue-500 text-white px-1 rounded";
          hostBadge.textContent = "Host";
          infoDiv.appendChild(hostBadge);
        }
        return;
      }

      const participantElement = document.createElement("div");
      participantElement.className = `flex items-center justify-between p-2 ${id === "local" ? "bg-gray-700" : "hover:bg-gray-700"} rounded`;
      participantElement.dataset.id = id;

      const infoDiv = document.createElement("div");
      infoDiv.className = "flex items-center space-x-2";

      const avatar = document.createElement("div");
      avatar.className = `w-8 h-8 rounded-full ${id === "local" ? "bg-blue-500" : "bg-purple-500"} flex items-center justify-center text-xs`;
      avatar.innerHTML = id === "local" ? '<i class="fas fa-user"></i>' : name.split(" ").map((n) => n[0]).join("");

      const nameSpan = document.createElement("span");
      nameSpan.className = "font-medium text-sm";
      nameSpan.textContent = name;

      infoDiv.appendChild(avatar);
      infoDiv.appendChild(nameSpan);

      if (isHost) {
        const hostBadge = document.createElement("span");
        hostBadge.className = "host-badge text-xs bg-blue-500 text-white px-1 rounded";
        hostBadge.textContent = "Host";
        infoDiv.appendChild(hostBadge);
      }

      if (isHandRaised) {
        const handBadge = document.createElement("span");
        handBadge.className = "hand-raised-badge text-xs bg-yellow-500 text-yellow-900 px-1 rounded";
        handBadge.textContent = "Hand raised";
        infoDiv.appendChild(handBadge);
      }

      if (isScreenSharing || state.screenSharingParticipant === id) {
        const screenShareIndicator = document.createElement("span");
        screenShareIndicator.className = "participant-screen-sharing text-xs bg-green-500 text-white px-1 rounded";
        screenShareIndicator.textContent = "Screen Sharing";
        infoDiv.appendChild(screenShareIndicator);
      }

      const controlsDiv = document.createElement("div");
      controlsDiv.className = "flex space-x-1";

      const muteBtn = document.createElement("button");
      muteBtn.className = "text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded";
      muteBtn.innerHTML = '<i class="fas fa-microphone"></i>';
      muteBtn.addEventListener("click", () => toggleRemoteMute(id));

      const videoBtn = document.createElement("button");
      videoBtn.className = "text-xs bg-gray-600 hover:bg-gray-500 px-2 py-1 rounded";
      videoBtn.innerHTML = '<i class="fas fa-video"></i>';
      videoBtn.addEventListener("click", () => toggleRemoteVideo(id));

      controlsDiv.appendChild(muteBtn);
      controlsDiv.appendChild(videoBtn);

      participantElement.appendChild(infoDiv);
      participantElement.appendChild(controlsDiv);

      elements.participantsList.appendChild(participantElement);
      updateParticipantCount();
    }

    // Update Participant Count
    function updateParticipantCount() {
      const count = Math.max(1, elements.participantsList.children.length);
      elements.participantCount.textContent = count;
      elements.participantCountSidebar.textContent = count;
    }

    // Toggle Microphone
    function toggleMic() {
      state.isMicOn = !state.isMicOn;
      let hasAudio = false;

      if (state.localStream) {
        state.localStream.getAudioTracks().forEach((track) => {
          track.enabled = state.isMicOn;
          hasAudio = true;
        });
      }

      if (state.isScreenSharing && state.screenStream) {
        state.screenStream.getAudioTracks().forEach((track) => {
          if (track.kind === "audio" && track.label.includes("microphone")) {
            track.enabled = state.isMicOn;
            hasAudio = true;
          }
        });
      }

      if (!hasAudio && !state.isMicOn) {
        showNotification("No microphone detected");
        state.isMicOn = false;
      }

      elements.micToggle.innerHTML = `<i class="fas ${state.isMicOn ? "fa-microphone text-green-400" : "fa-microphone-slash"}"></i>`;
      showNotification(state.isMicOn ? "Microphone on" : "Microphone off");

      state.peers.forEach((pc) => {
        const sender = pc.getSenders().find((s) => s.track?.kind === "audio" && s.track.label.includes("microphone"));
        if (sender && sender.track) {
          sender.track.enabled = state.isMicOn;
        }
      });

      socket.emit("toggle-mic", { room, micOn: state.isMicOn });
    }

    // Toggle Camera
    function toggleCamera() {
      state.isCameraOn = !state.isCameraOn;
      if (state.localStream && !state.isScreenSharing) {
        state.localStream.getVideoTracks().forEach((track) => {
          track.enabled = state.isCameraOn;
        });
      }
      elements.cameraToggle.innerHTML = `<i class="fas ${state.isCameraOn ? "fa-video text-green-400" : "fa-video-slash"}"></i>`;
      showNotification(state.isCameraOn ? "Camera on" : "Camera off");
      socket.emit("toggle-camera", { room, cameraOn: state.isCameraOn });
    }

    // Toggle Screen Sharing
    async function toggleScreenShare() {
      if (state.isScreenSharing) {
        stopScreenShare();
      } else {
        try {
          state.screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: { cursor: "always", displaySurface: "monitor" },
            audio: {
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true,
              sampleRate: 48000,
              channelCount: 2,
              suppressLocalAudioPlayback: true,
            },
          });

          let micAudioStream = null;
          if (state.isMicOn && state.micStream) {
            try {
              micAudioStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                  echoCancellation: true,
                  noiseSuppression: true,
                  autoGainControl: true,
                  sampleRate: 48000,
                  channelCount: 2,
                },
              });
            } catch (err) {
              console.warn("Could not get microphone for screen sharing:", err);
              showNotification("Microphone access denied for screen sharing");
            }
          }

          let combinedStream = state.screenStream;
          if (micAudioStream && micAudioStream.getAudioTracks().length > 0) {
            combinedStream = combineAudioStreams(micAudioStream, state.screenStream);
            state.screenStream.getVideoTracks().forEach((track) => combinedStream.addTrack(track));
          }

          if (state.localStream && state.localStream.getAudioTracks().length > 0) {
            state.localStream.getAudioTracks().forEach((track) => {
              track.enabled = false;
            });
          }

          const videoTrack = combinedStream.getVideoTracks()[0];
          const audioTracks = combinedStream.getAudioTracks();
          state.peers.forEach((pc, id) => {
            const videoSender = pc.getSenders().find((s) => s.track?.kind === "video");
            if (videoSender) videoSender.replaceTrack(videoTrack);
            audioTracks.forEach((audioTrack) => {
              const audioSender = pc.getSenders().find((s) => s.track?.kind === "audio");
              if (audioSender) {
                audioSender.replaceTrack(audioTrack);
              } else {
                pc.addTrack(audioTrack, combinedStream);
              }
            });
          });

          videoTrack.onended = stopScreenShare;

          createVideoElement("local", userName, combinedStream, true, true);

          const screenShareVideo = elements.screenShareOverlay.querySelector("video");
          screenShareVideo.srcObject = combinedStream;
          screenShareVideo.muted = true;
          screenShareVideo.classList.remove("camera-video");
          screenShareVideo.play().catch((err) => console.error("Screen share video play failed:", err));
          elements.screenShareOverlay.classList.remove("hidden");

          state.isScreenSharing = true;
          state.screenSharingParticipant = socket.id;
          elements.screenShareBtn.innerHTML = '<i class="fas fa-desktop text-green-400"></i>';
          showNotification("Screen sharing started with audio");

          updateParticipantList();

          socket.emit("screen-share", { room, sharing: true, participantId: socket.id });
        } catch (err) {
          showNotification(`Could not start screen sharing: ${err.message}`);
          state.screenStream = null;
        }
      }
    }

    // Stop Screen Sharing
    function stopScreenShare() {
      if (!state.isScreenSharing) return;

      if (state.localStream) {
        const videoTrack = state.localStream.getVideoTracks()[0];
        const audioTrack = state.localStream.getAudioTracks()[0];
        if (videoTrack) {
          videoTrack.enabled = state.isCameraOn;
          state.peers.forEach((pc, id) => {
            const videoSender = pc.getSenders().find((s) => s.track?.kind === "video");
            if (videoSender) videoSender.replaceTrack(videoTrack);
          });
        }
        if (audioTrack) {
          audioTrack.enabled = state.isMicOn;
          state.peers.forEach((pc, id) => {
            const audioSender = pc.getSenders().find((s) => s.track?.kind === "audio");
            if (audioSender) audioSender.replaceTrack(audioTrack);
            else pc.addTrack(audioTrack, state.localStream);
          });
        }
      }

      if (state.screenStream) {
        state.screenStream.getTracks().forEach((track) => track.stop());
        state.screenStream = null;
      }

      createVideoElement("local", userName, state.localStream, true, false);

      elements.screenShareOverlay.classList.add("hidden");
      state.isScreenSharing = false;
      state.screenSharingParticipant = null;
      elements.screenShareBtn.innerHTML = '<i class="fas fa-desktop"></i>';
      showNotification("Screen sharing stopped");

      updateParticipantList();

      socket.emit("screen-share", { room, sharing: false, participantId: socket.id });
    }

    // Setup More Options
    function setupMoreOptions() {
      const settingsOption = elements.moreOptionsPopup.querySelector("#settings-option");
      const meetingOptions = elements.moreOptionsPopup.querySelector("#meeting-options");
      const captionsOption = elements.moreOptionsPopup.querySelector("#captions-option");
      const languageOption = elements.moreOptionsPopup.querySelector("#language-option");
      const fullscreenOption = elements.moreOptionsPopup.querySelector("#fullscreen-option");
      const captionLanguageOption = elements.moreOptionsPopup.querySelector("#caption-language-option");

      settingsOption.addEventListener("click", () => {
        elements.moreOptionsPopup.classList.add("hidden");
        showSettingsModal();
      });

      meetingOptions.addEventListener("click", () => {
        elements.moreOptionsPopup.classList.add("hidden");
        showMeetingOptionsModal();
      });

      captionsOption.addEventListener("click", () => {
        elements.moreOptionsPopup.classList.add("hidden");
        toggleCaptions();
      });

      captionLanguageOption.addEventListener("click", () => {
        elements.moreOptionsPopup.classList.add("hidden");
        showCaptionLanguageModal();
      });

      languageOption.addEventListener("click", () => {
        elements.moreOptionsPopup.classList.add("hidden");
        showLanguageInterpretationModal();
      });

      fullscreenOption.addEventListener("click", () => {
        elements.moreOptionsPopup.classList.add("hidden");
        toggleFullScreen();
      });
    }

    // Show Settings Modal
    function showSettingsModal() {
      let settingsModal = document.getElementById("settings-modal");
      if (!settingsModal) {
        settingsModal = document.createElement("div");
        settingsModal.id = "settings-modal";
        settingsModal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
        settingsModal.setAttribute("role", "dialog");
        settingsModal.setAttribute("aria-labelledby", "settings-modal-title");
        settingsModal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
          <div class="flex justify-between items-center mb-3">
            <h2 id="settings-modal-title" class="text-lg font-bold">Settings</h2>
            <button id="close-settings-modal" class="text-gray-400 hover:text-white" aria-label="Close settings modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label for="settings-username" class="block text-sm font-medium mb-1">Your Name</label>
              <input type="text" id="settings-username" value="${sanitizeInput(userName)}" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" maxlength="50" required aria-required="true" />
            </div>
            <div>
              <label for="video-quality" class="block text-sm font-medium mb-1">Video Quality</label>
              <select id="video-quality" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm" aria-describedby="video-quality-desc">
                <option value="low">Low (360p)</option>
                <option value="medium" selected>Medium (720p)</option>
                <option value="high">High (1080p)</option>
              </select>
              <p id="video-quality-desc" class="text-xs text-gray-400 mt-1">Higher quality may impact performance</p>
            </div>
            <button id="save-settings" class="w-full bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm" aria-label="Save settings">
              Save
            </button>
          </div>
        </div>
      `;
        document.body.appendChild(settingsModal);

        const closeModal = settingsModal.querySelector("#close-settings-modal");
        const saveSettings = settingsModal.querySelector("#save-settings");
        const usernameInput = settingsModal.querySelector("#settings-username");

        closeModal.addEventListener("click", () => {
          settingsModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
          usernameInput.value = sanitizeInput(userName);
        });

        saveSettings.addEventListener("click", async () => {
          const newName = usernameInput.value.trim();
          const videoQuality = settingsModal.querySelector("#video-quality").value;

          if (!newName || newName.length > 50) {
            showNotification("Please enter a valid name (1-50 characters)");
            return;
          }

          userName = sanitizeInput(newName);
          sessionStorage.setItem("userName", userName);
          state.participantNames.set("local", userName);
          updateLocalVideoName();
          socket.emit("update-name", { room, name: userName });

          await updateVideoQuality(videoQuality);

          showNotification("Settings updated successfully");
          settingsModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        usernameInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") saveSettings.click();
        });
      }
      settingsModal.classList.remove("hidden");
      elements.meetingScreen.classList.add("blur-background");
      settingsModal.querySelector("#settings-username").focus();
    }

    function showCaptionLanguageModal() {
      let captionLanguageModal = document.getElementById("caption-language-modal");
      if (!captionLanguageModal) {
        captionLanguageModal = document.createElement("div");
        captionLanguageModal.id = "caption-language-modal";
        captionLanguageModal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
        captionLanguageModal.setAttribute("role", "dialog");
        captionLanguageModal.setAttribute("aria-labelledby", "caption-language-modal-title");
        captionLanguageModal.innerHTML = `
      <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
        <div class="flex justify-between items-center mb-3">
          <h2 id="caption-language-modal-title" class="text-lg font-bold">Caption Language</h2>
          <button id="close-caption-language-modal" class="text-gray-400 hover:text-white" aria-label="Close caption language modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="space-y-4">
          <div>
            <label for="caption-language" class="block text-sm font-medium mb-1">Select Language</label>
            <select id="caption-language" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
              <option value="en-US">English (US)</option>
              <option value="es-ES">Spanish</option>
              <option value="fr-FR">French</option>
              <option value="de-DE">German</option>
              <option value="zh-CN">Chinese (Simplified)</option>
            </select>
          </div>
          <button id="save-caption-language" class="w-full bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm" aria-label="Save caption language">
            Save
          </button>
        </div>
      </div>
    `;
        document.body.appendChild(captionLanguageModal);

        const closeModal = captionLanguageModal.querySelector("#close-caption-language-modal");
        const saveLanguage = captionLanguageModal.querySelector("#save-caption-language");

        closeModal.addEventListener("click", () => {
          captionLanguageModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        saveLanguage.addEventListener("click", () => {
          const language = captionLanguageModal.querySelector("#caption-language").value;
          state.captionLanguage = language;
          if (state.isCaptionsOn && state.recognition) {
            state.recognition._manuallyStopped = true;
            state.recognition.stop();
            state.recognition = null;
            toggleCaptions(); // Disable captions
            toggleCaptions(); // Re-enable with new language
          }
          showNotification(`Caption language set to ${language}`);
          captionLanguageModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        captionLanguageModal.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && e.target.tagName !== "SELECT") {
            saveLanguage.click();
          }
        });
      }
      captionLanguageModal.classList.remove("hidden");
      elements.meetingScreen.classList.add("blur-background");
      captionLanguageModal.querySelector("#caption-language").focus();
    }

    // Update Local Video Name
    function updateLocalVideoName() {
      const localContainer = document.getElementById("video-container-local");
      if (localContainer) {
        const nameLabel = localContainer.querySelector(".participant-name");
        if (nameLabel) {
          nameLabel.textContent = sanitizeInput(userName);
        }
      }
      updateParticipantList();
    }

    // Update Video Quality
    async function updateVideoQuality(quality) {
      let constraints;
      switch (quality) {
        case "low":
          constraints = { width: { ideal: 640 }, height: { ideal: 360 }, frameRate: { ideal: 15 } };
          break;
        case "medium":
          constraints = { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } };
          break;
        case "high":
          constraints = { width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 60 } };
          break;
        default:
          constraints = { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 } };
      }

      if (state.localStream && !state.isScreenSharing) {
        const videoTrack = state.localStream.getVideoTracks()[0];
        if (videoTrack) {
          try {
            await videoTrack.applyConstraints(constraints);
            state.peers.forEach((pc) => {
              const sender = pc.getSenders().find((s) => s.track?.kind === "video");
              if (sender && sender.track) {
                sender.replaceTrack(videoTrack).catch((err) => {
                  console.error("Failed to replace video track:", err);
                });
              }
            });
            showNotification(`Video quality set to ${quality}`);
          } catch (err) {
            showNotification(`Failed to set video quality: ${err.message}`);
          }
        } else {
          showNotification("No video track available");
        }
      }
    }

    // Show Meeting Options Modal
    function showMeetingOptionsModal() {
      let meetingOptionsModal = document.getElementById("meeting-options-modal");
      if (!meetingOptionsModal) {
        meetingOptionsModal = document.createElement("div");
        meetingOptionsModal.id = "meeting-options-modal";
        meetingOptionsModal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
        meetingOptionsModal.setAttribute("role", "dialog");
        meetingOptionsModal.setAttribute("aria-labelledby", "meeting-options-modal-title");
        meetingOptionsModal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
          <div class="flex justify-between items-center mb-3">
            <h2 id="meeting-options-modal-title" class="text-lg font-bold">Meeting Options</h2>
            <button id="close-meeting-options-modal" class="text-gray-400 hover:text-white" aria-label="Close meeting options modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="lock-meeting" class="bg-gray-700 border-gray-600" ${state.meetingOptions?.lockMeeting ? "checked" : ""} />
                <span>Lock Meeting</span>
              </label>
              <p class="text-xs text-gray-400 mt-1">Prevent new participants from joining</p>
            </div>
            <div>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="mute-on-join" class="bg-gray-700 border-gray-600" ${state.meetingOptions?.muteOnJoin ? "checked" : ""} />
                <span>Mute participants on join</span>
              </label>
            </div>
            <div>
              <label class="flex items-center space-x-2 text-sm">
                <input type="checkbox" id="video-off-on-join" class="bg-gray-700 border-gray-600" ${state.meetingOptions?.videoOffOnJoin ? "checked" : ""} />
                <span>Video off for participants on join</span>
              </label>
            </div>
            <button id="save-meeting-options" class="w-full bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm" aria-label="Save meeting options">
              Save
            </button>
          </div>
        </div>
      `;
        document.body.appendChild(meetingOptionsModal);

        const closeModal = meetingOptionsModal.querySelector("#close-meeting-options-modal");
        const saveOptions = meetingOptionsModal.querySelector("#save-meeting-options");

        closeModal.addEventListener("click", () => {
          meetingOptionsModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        saveOptions.addEventListener("click", () => {
          state.meetingOptions = {
            lockMeeting: meetingOptionsModal.querySelector("#lock-meeting").checked,
            muteOnJoin: meetingOptionsModal.querySelector("#mute-on-join").checked,
            videoOffOnJoin: meetingOptionsModal.querySelector("#video-off-on-join").checked,
          };

          socket.emit("update-meeting-options", { room, ...state.meetingOptions });
          showNotification("Meeting options updated");
          meetingOptionsModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        meetingOptionsModal.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && e.target.tagName !== "INPUT") {
            saveOptions.click();
          }
        });
      }
      meetingOptionsModal.classList.remove("hidden");
      elements.meetingScreen.classList.add("blur-background");
      meetingOptionsModal.querySelector("#lock-meeting").focus();
    }

    // Toggle Captions
    function toggleCaptions() {
      state.isCaptionsOn = !state.isCaptionsOn;
      const captionsOption = elements.moreOptionsPopup.querySelector("#captions-option");

      if (state.isCaptionsOn) {
        if ("SpeechRecognition" in window || "webkitSpeechRecognition" in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          state.recognition = new SpeechRecognition();
          state.recognition.continuous = true;
          state.recognition.interimResults = true;
          state.recognition.lang = "en-US"; // Default language; can be made configurable
          state.recognition.maxAlternatives = 1;

          state.recognition.onresult = (event) => {
            let finalTranscript = "";
            let interimTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
              const transcript = event.results[i][0].transcript;
              if (event.results[i].isFinal) {
                finalTranscript += transcript + " ";
              } else {
                interimTranscript += transcript;
              }
            }
            if (finalTranscript) {
              socket.emit("caption", { room, text: finalTranscript.trim(), participantId: socket.id });
              displayCaption(finalTranscript.trim(), userName, false);
            }
            if (interimTranscript) {
              displayCaption(interimTranscript, userName, true);
            }
          };

          state.recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            let errorMessage = "Caption error";
            switch (event.error) {
              case "no-speech":
                return; // Ignore no-speech errors
              case "audio-capture":
                errorMessage = "Microphone access denied";
                break;
              case "not-allowed":
                errorMessage = "Permission to use microphone was denied";
                break;
              case "network":
                errorMessage = "Network error occurred";
                break;
              default:
                errorMessage = `Caption error: ${event.error}`;
            }
            showNotification(errorMessage);
            if (event.error !== "no-speech") {
              toggleCaptions(); // Disable captions on critical errors
            }
          };

          state.recognition.onend = () => {
            if (state.isCaptionsOn && !state.recognition._manuallyStopped) {
              try {
                state.recognition.start();
              } catch (err) {
                showNotification("Failed to restart speech recognition");
                toggleCaptions();
              }
            }
          };

          try {
            state.recognition.start();
            showNotification("Captions enabled");
          } catch (err) {
            showNotification(`Failed to start captions: ${err.message}`);
            state.isCaptionsOn = false;
            captionsOption.querySelector("span").textContent = "Turn on captions";
            return;
          }
        } else {
          showNotification("Captions are not supported in this browser. Try Chrome or Edge.");
          state.isCaptionsOn = false;
          captionsOption.querySelector("span").textContent = "Turn on captions";
          return;
        }
      } else {
        if (state.recognition) {
          state.recognition._manuallyStopped = true;
          state.recognition.stop();
          state.recognition = null;
        }
        const captionsContainer = document.getElementById("captions-container");
        if (captionsContainer) captionsContainer.remove();
        showNotification("Captions disabled");
      }

      captionsOption.querySelector("span").textContent = state.isCaptionsOn ? "Turn off captions" : "Turn on captions";
    }

    // Display Caption
    function displayCaption(text, name, isInterim = false) {
      if (!state.isCaptionsOn) return;

      let captionsContainer = document.getElementById("captions-container");
      if (!captionsContainer) {
        captionsContainer = document.createElement("div");
        captionsContainer.id = "captions-container";
        captionsContainer.className = "fixed bottom-20 left-2 right-2 bg-black bg-opacity-75 text-white text-sm p-2 rounded-lg max-h-40 overflow-y-auto";
        captionsContainer.setAttribute("role", "region");
        captionsContainer.setAttribute("aria-live", "polite");
        elements.videoGrid.appendChild(captionsContainer);
      }

      const captionId = `caption-${name}-${isInterim ? "interim" : "final"}-${Date.now()}`;
      let captionElement = document.getElementById(captionId);

      if (!captionElement) {
        captionElement = document.createElement("div");
        captionElement.id = captionId;
        captionElement.className = `caption ${isInterim ? "text-gray-400" : "text-white"} mb-1`;
        captionsContainer.appendChild(captionElement);
      }

      captionElement.innerHTML = `<span class="font-medium">${sanitizeInput(name)}:</span> ${sanitizeInput(text)}`;

      // Remove old captions to prevent clutter
      const captions = captionsContainer.querySelectorAll(".caption");
      if (captions.length > 10) {
        captions[0].remove();
      }

      captionsContainer.scrollTop = captionsContainer.scrollHeight;
    }

    // Show Language Interpretation Modal
    function showLanguageInterpretationModal() {
      let languageModal = document.getElementById("language-interpretation-modal");
      if (!languageModal) {
        languageModal = document.createElement("div");
        languageModal.id = "language-interpretation-modal";
        languageModal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50";
        languageModal.setAttribute("role", "dialog");
        languageModal.setAttribute("aria-labelledby", "language-modal-title");
        languageModal.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-4 w-full max-w-md">
          <div class="flex justify-between items-center mb-3">
            <h2 id="language-modal-title" class="text-lg font-bold">Language Interpretation</h2>
            <button id="close-language-modal" class="text-gray-400 hover:text-white" aria-label="Close language interpretation modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-4">
            <div>
              <label for="interpretation-language" class="block text-sm font-medium mb-1">Select Language</label>
              <select id="interpretation-language" class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
              </select>
            </div>
            <button id="start-interpretation" class="w-full bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm" aria-label="Start language interpretation">
              Start Interpretation
            </button>
          </div>
        </div>
      `;
        document.body.appendChild(languageModal);

        const closeModal = languageModal.querySelector("#close-language-modal");
        const startInterpretation = languageModal.querySelector("#start-interpretation");

        closeModal.addEventListener("click", () => {
          languageModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        startInterpretation.addEventListener("click", () => {
          const language = languageModal.querySelector("#interpretation-language").value;
          socket.emit("start-interpretation", { room, language, participantId: socket.id });
          showNotification(`Started interpretation for ${language.toUpperCase()} (placeholder)`);
          languageModal.classList.add("hidden");
          elements.meetingScreen.classList.remove("blur-background");
        });

        languageModal.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && e.target.tagName !== "SELECT") {
            startInterpretation.click();
          }
        });
      }
      languageModal.classList.remove("hidden");
      elements.meetingScreen.classList.add("blur-background");
      languageModal.querySelector("#interpretation-language").focus();
    }

    // Toggle Full Screen
    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().then(() => {
          showNotification("Entered full screen mode");
          elements.fullscreenOption.querySelector("span").textContent = "Exit full screen";
        }).catch((err) => {
          showNotification(`Failed to enter full screen: ${err.message}`);
        });
      } else {
        document.exitFullscreen().then(() => {
          showNotification("Exited full screen mode");
          elements.fullscreenOption.querySelector("span").textContent = "Full screen";
        }).catch((err) => {
          showNotification(`Failed to exit full screen: ${err.message}`);
        });
      }
    }

    // Toggle Raise Hand
    function toggleRaiseHand() {
      state.isHandRaised = !state.isHandRaised;
      socket.emit("toggle-hand", { room, raised: state.isHandRaised });
      elements.raiseHandBtn.innerHTML = `<i class="fas fa-hand-paper ${state.isHandRaised ? "text-yellow-400" : ""}"></i>`;
      showNotification(state.isHandRaised ? "Your hand is raised" : "Your hand is lowered");
      updateParticipantList();
    }

    // Toggle Recording
    function toggleRecording() {
      state.isRecording = !state.isRecording;
      elements.recordBtn.innerHTML = `<i class="fas fa-circle ${state.isRecording ? "text-red-500" : "text-gray-400"}"></i>`;
      showNotification(state.isRecording ? "Recording started" : "Recording stopped");
      socket.emit("toggle-recording", { room, recording: state.isRecording });
    }

    // Toggle Sidebar
    function toggleSidebar() {
      state.isSidebarOpen = !state.isSidebarOpen;
      elements.sidebar.classList.toggle("sidebar-hidden", !state.isSidebarOpen);
      if (state.isSidebarOpen && state.activeTab === "chat") {
        renderChatMessages();
        elements.chatInput.focus();
      }
    }

    // Show Sidebar Tab
    function showTab(tab) {
      state.activeTab = tab;
      elements.sidebarTabs.querySelectorAll("button").forEach((btn) => {
        btn.classList.toggle("bg-gray-700", btn.getAttribute("data-tab") === tab);
      });
      elements.participantsTab.classList.toggle("hidden", tab !== "participants");
      elements.chatTab.classList.toggle("hidden", tab !== "chat");
      if (tab === "chat") {
        renderChatMessages();
        elements.chatInput.focus();
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      }
    }

    // Toggle More Options
    function toggleMoreOptions() {
      elements.moreOptionsPopup.classList.toggle("hidden");
    }

    // Toggle Reactions Popup
    function toggleReactionsPopup() {
      elements.reactionsPopup.classList.toggle("hidden");
    }

    // Toggle Virtual Background Popup
    function toggleVirtualBackgroundPopup() {
      elements.virtualBackgroundPopup.classList.toggle("hidden");
    }

    // Send Chat Message
    function sendChatMessage() {
      const message = elements.chatInput.value.trim();
      if (message && message.length <= 500) {
        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        const chatMessage = { name: userName, message: sanitizeInput(message), time };
        socket.emit("chat-message", { room, ...chatMessage });
        addChatMessage(userName, message, time);
        elements.chatInput.value = "";
        socket.emit("stop-typing", { room, name: userName });
      } else {
        showNotification("Message must be 1-500 characters");
      }
    }

    // Add Chat Message
    function addChatMessage(name, message, time) {
      state.chatMessages.push({ name, message, time });
      renderChatMessages();
    }

    // Render Chat Messages
    function renderChatMessages() {
      elements.chatMessages.innerHTML = "";
      state.chatMessages.forEach(({ name, message, time }) => {
        const messageDiv = document.createElement("div");
        messageDiv.className = "chat-message flex items-start mb-2";
        messageDiv.setAttribute("role", "listitem");

        const avatar = document.createElement("div");
        avatar.className = `w-6 h-6 rounded-full ${name === userName ? "bg-blue-500" : "bg-purple-500"} flex items-center justify-center text-xs mr-2`;
        avatar.textContent = name.split(" ").map((n) => n[0]).join("");
        avatar.setAttribute("aria-hidden", "true");

        const contentDiv = document.createElement("div");
        contentDiv.className = "flex-1";

        const headerDiv = document.createElement("div");
        headerDiv.className = "flex justify-between items-center mb-1";

        const nameSpan = document.createElement("span");
        nameSpan.className = "font-medium text-sm";
        nameSpan.textContent = sanitizeInput(name);

        const timeSpan = document.createElement("span");
        timeSpan.className = "text-xs text-gray-400";
        timeSpan.textContent = time;

        const messageP = document.createElement("p");
        messageP.className = "text-sm break-words";
        messageP.textContent = sanitizeInput(message);

        headerDiv.appendChild(nameSpan);
        headerDiv.appendChild(timeSpan);
        contentDiv.appendChild(headerDiv);
        contentDiv.appendChild(messageP);

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);

        elements.chatMessages.appendChild(messageDiv);
      });

      // Display typing indicators
      const typingIndicator = document.createElement("div");
      typingIndicator.className = "typing-indicator text-sm text-gray-400";
      typingIndicator.setAttribute("aria-live", "polite");
      if (state.typingUsers.size > 0) {
        const users = Array.from(state.typingUsers).join(", ");
        typingIndicator.textContent = `${users} ${state.typingUsers.size > 1 ? "are" : "is"} typing`;
        const dots = document.createElement("span");
        dots.className = "flex";
        for (let i = 0; i < 3; i++) {
          const dot = document.createElement("span");
          dot.className = "typing-dot";
          dots.appendChild(dot);
        }
        typingIndicator.appendChild(dots);
        elements.chatMessages.appendChild(typingIndicator);
      }

      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    // Send Reaction
    function sendReaction(emoji) {
      socket.emit("reaction", { room, emoji, name: userName });
      showReaction(emoji, userName);
    }

    // Show Reaction
    function showReaction(emoji, name) {
      const reactionDiv = document.createElement("div");
      reactionDiv.className = "reaction-animation";
      reactionDiv.textContent = emoji;
      reactionDiv.style.left = `${Math.random() * 80 + 10}%`;
      reactionDiv.style.bottom = "100px";
      elements.videoGrid.appendChild(reactionDiv);
      setTimeout(() => reactionDiv.remove(), 2000);
      showNotification(`${sanitizeInput(name)} sent ${emoji}`);
    }

    // Copy Meeting Link
    async function copyMeetingLinkToClipboard(event) {
      const isCopyMeetingId = event.target.closest("#copy-meeting-id");
      const link = `${window.location.origin}/meeting.html?room=${encodeURIComponent(room)}`;
      const textToCopy = isCopyMeetingId ? room : link;

      try {
        await navigator.clipboard.writeText(textToCopy);
        showNotification(isCopyMeetingId ? "Meeting ID copied to clipboard" : "Meeting link copied to clipboard");
      } catch {
        showNotification("Failed to copy");
      }
    }

    // Send Email Invites
    function sendEmailInvites() {
      const emails = (
        elements.inviteEmails.value.trim() ||
        elements.inviteParticipant.value.trim()
      )
        .split(",")
        .map((email) => email.trim())
        .filter((email) => email);
      if (emails.length) {
        showNotification(`Invites sent to: ${emails.join(", ")}`);
        socket.emit("send-invites", { room, emails });
        elements.inviteEmails.value = "";
        elements.inviteParticipant.value = "";
        hideInviteFriendsModal();
      } else {
        showNotification("Please enter at least one email address");
      }
    }

    // Share via WhatsApp
    function shareViaWhatsapp() {
      const link = encodeURIComponent(
        `${window.location.origin}/meeting.html?room=${encodeURIComponent(room)}`
      );
      window.open(`https://wa.me/?text=Join my meeting: ${link}`, "_blank");
      showNotification("Opening WhatsApp to share meeting link");
    }

    // Share via Email
    function shareViaEmail() {
      const link = `${window.location.origin}/meeting.html?room=${encodeURIComponent(room)}`;
      window.open(
        `mailto:?subject=Join My Meeting&body=Join my meeting: ${link}`
      );
      showNotification("Opening email client to share meeting link");
    }

    // Share via SMS
    function shareViaSms() {
      const link = `${window.location.origin}/meeting.html?room=${encodeURIComponent(room)}`;
      window.open(`sms:?body=Join my meeting: ${link}`);
      showNotification("Opening SMS to share meeting link");
    }

    let notificationTimeout = null;

    // Show Notification
    function showNotification(message) {
      elements.notificationMessage.textContent = sanitizeInput(message);
      if (notificationTimeout) {
        clearTimeout(notificationTimeout);
      }
      elements.notificationToast.classList.remove("hidden");
      notificationTimeout = setTimeout(() => {
        elements.notificationToast.classList.add("hidden");
        notificationTimeout = null;
      }, 3000);
    }

    // Show Invite Friends Modal
    function showInviteFriendsModal() {
      updateMeetingLink();
      elements.inviteFriendsModal.classList.remove("hidden");
    }

    // Hide Invite Friends Modal
    function hideInviteFriendsModal() {
      elements.inviteFriendsModal.classList.add("hidden");
    }

    // Toggle Remote Mute
    function toggleRemoteMute(participantId) {
      socket.emit("toggle-remote-mute", { room, participantId });
      showNotification(
        `Requested mute toggle for ${state.participantNames.get(participantId) || "participant"}`
      );
    }

    // Toggle Remote Video
    function toggleRemoteVideo(participantId) {
      socket.emit("toggle-remote-video", { room, participantId });
      showNotification(
        `Requested video toggle for ${state.participantNames.get(participantId) || "participant"}`
      );
    }

    // Update Participant List
    function updateParticipantList() {
      elements.participantsList.innerHTML = "";
      addParticipant("local", userName, state.isHost, state.isHandRaised, state.screenSharingParticipant === socket.id);
      state.peers.forEach((_, id) => {
        const name = state.participantNames.get(id) || "Anonymous";
        const handRaised = state.peerStreams.get(id)?.handRaised || false;
        const isScreenSharing = state.screenSharingParticipant === id;
        addParticipant(id, name, false, handRaised, isScreenSharing);
      });
    }

    // Leave Call
    function leaveCall() {
      if (confirm("Are you sure you want to leave the meeting?")) {
        cleanup();
        window.location.href = "/";
      }
    }

    // End Call
    function endCall() {
      if (confirm("Are you sure you want to end the meeting for everyone?")) {
        socket.emit("end-meeting", { room });
        cleanup();
        window.location.href = "/";
      }
    }

    // Return to Home Screen
    function returnToHomeScreen() {
      if (confirm("Are you sure you want to leave the meeting?")) {
        cleanup();
        window.location.href = "/";
      }
    }

    // Cleanup Resources
    function cleanup() {
      if (state.cleanupInterval) {
        clearInterval(state.cleanupInterval);
        state.cleanupInterval = null;
      }

      if (state.localStream) {
        state.localStream.getTracks().forEach((track) => track.stop());
        state.localStream = null;
      }

      if (state.screenStream) {
        state.screenStream.getTracks().forEach((track) => track.stop());
        state.screenStream = null;
      }

      if (state.recognition) {
        state.recognition.stop();
        delete state.recognition;
      }

      state.peers.forEach((pc) => pc.close());
      state.peers.clear();

      state.peerStreams.forEach((stream) => stream.getTracks().forEach((track) => track.stop()));
      state.peerStreams.clear();

      ["settings-modal", "meeting-options-modal", "language-interpretation-modal", "captions-container"].forEach((id) => {
        const element = document.getElementById(id);
        if (element) element.remove();
      });

      socket.disconnect();
    }

    // Cleanup Stale Videos
    function cleanupStaleVideos() {
      const containers = elements.videoGrid.querySelectorAll('[id^="video-container-"]');
      containers.forEach((container) => {
        const id = container.id.replace("video-container-", "");
        if (id === "local") return;

        const video = container.querySelector("video");
        const stream = video?.srcObject;

        if (
          (!state.peers.has(id) && !state.peerStreams.has(id)) ||
          (stream && !stream.active) ||
          !video ||
          video.paused
        ) {
          container.remove();
          if (state.focusedParticipant === id) {
            const remainingParticipants = Array.from(state.peers.keys()).concat("local");
            state.focusedParticipant = remainingParticipants.length > 0 ? remainingParticipants[0] : "local";
            const newMainContainer = document.getElementById(`video-container-${state.focusedParticipant}`);
            if (newMainContainer) {
              newMainContainer.className = "video-main";
              elements.videoGrid.insertBefore(newMainContainer, elements.videoGrid.firstChild);
            }
          }
        }
      });

      const secondaryContainer = elements.videoGrid.querySelector(".video-secondary-container");
      if (secondaryContainer && secondaryContainer.children.length === 0) {
        secondaryContainer.remove();
      }

      updateVideoGridLayout();
    }

    // Create Peer Connection
    function createPeerConnection(peerId, peerName, initiator) {
      const pc = new RTCPeerConnection(config);

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === "failed" || pc.connectionState === "disconnected") {
          showNotification(`${state.participantNames.get(peerId) || "A participant"}'s connection failed`);
          cleanupParticipant(peerId);
        }
      };

      pc.oniceconnectionstatechange = () => {
        if (pc.iceConnectionState === "failed") {
          pc.restartIce();
        }
      };

      if (state.isScreenSharing && state.screenStream) {
        state.screenStream.getTracks().forEach((track) => {
          pc.addTrack(track, state.screenStream);
        });
      } else if (state.localStream) {
        state.localStream.getTracks().forEach((track) => {
          pc.addTrack(track, state.localStream);
        });
      }

      pc.ontrack = (event) => {
        if (event.streams[0]) {
          if (!state.peerStreams.has(peerId)) {
            state.peerStreams.set(peerId, new MediaStream());
            state.peerStreams.get(peerId).name = peerName || state.participantNames.get(peerId) || "Anonymous";
            state.peerStreams.get(peerId).isScreenSharing = state.screenSharingParticipant === peerId;
          }
          event.streams[0].getTracks().forEach((track) => {
            state.peerStreams.get(peerId).addTrack(track);
          });
          createVideoElement(peerId, state.peerStreams.get(peerId).name, state.peerStreams.get(peerId), false, state.screenSharingParticipant === peerId);
          addParticipant(peerId, state.peerStreams.get(peerId).name, false, false, state.screenSharingParticipant === peerId);
        }
      };

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("signal", {
            to: peerId,
            signal: { candidate: event.candidate },
            name: userName,
          });
        }
      };

      if (initiator) {
        pc.onnegotiationneeded = async () => {
          try {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit("signal", {
              to: peerId,
              signal: pc.localDescription,
              name: userName,
            });
          } catch (e) {
            showNotification("Failed to establish connection");
          }
        };
      }

      state.peers.set(peerId, pc);
      return pc;
    }

    // Setup Socket Events
    function setupSocketEvents() {
      socket.on("connect_error", () => {
        showNotification("Connection to server failed. Retrying...");
      });

      socket.on("user-disconnected", (id) => {
        if (id === socket.id) return;
        const participantName = state.participantNames.get(id) || "Anonymous";
        state.typingUsers.delete(participantName);
        renderChatMessages();
        if (state.screenSharingParticipant === id) {
          state.screenSharingParticipant = null;
          elements.screenShareOverlay.classList.add("hidden");
        }
        showNotification(`${participantName} has left the meeting`);
        cleanupParticipant(id);
      });

      // In setupSocketEvents
      socket.on("all-users", (users, screenSharingParticipant) => {
        state.screenSharingParticipant = screenSharingParticipant?.id || null;
        users.forEach((user) => {
          if (user.id !== socket.id) {
            state.participantNames.set(user.id, sanitizeInput(user.name || "Anonymous"));
            addParticipant(user.id, user.name, user.isHost || false, false, state.screenSharingParticipant === user.id);
            createPeerConnection(user.id, user.name, true);
          }
        });
        updateParticipantList();
      });

      socket.on("user-connected", ({ id, name, isHost }) => {
        if (id === socket.id) return;
        state.participantNames.set(id, sanitizeInput(name || "Anonymous"));
        addParticipant(id, name, isHost || false, false, false);
        createPeerConnection(id, name, false);
        showNotification(`${state.participantNames.get(id)} has joined the meeting`);

        if (state.isHost && state.meetingOptions) {
          socket.emit("apply-meeting-options", { room, participantId: id, ...state.meetingOptions });
        }
        updateParticipantList();
      });

      socket.on("user-connected", ({ id, name }) => {
        if (id === socket.id) return;
        state.participantNames.set(id, sanitizeInput(name || "Anonymous"));
        createPeerConnection(id, name, false);
        showNotification(`${state.participantNames.get(id)} has joined the meeting`);

        if (state.isHost && state.meetingOptions) {
          socket.emit("apply-meeting-options", { room, participantId: id, ...state.meetingOptions });
        }
        updateParticipantList();
      });

      socket.on("signal", async (data) => {
        if (data.from === socket.id) return;
        let pc = state.peers.get(data.from);
        if (!pc) {
          state.participantNames.set(data.from, sanitizeInput(data.name || "Anonymous"));
          pc = createPeerConnection(data.from, data.name, false);
        }

        try {
          if (data.signal.type === "offer") {
            await pc.setRemoteDescription(new RTCSessionDescription(data.signal));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit("signal", {
              to: data.from,
              signal: pc.localDescription,
              name: userName,
            });
          } else if (data.signal.type === "answer") {
            await pc.setRemoteDescription(new RTCSessionDescription(data.signal));
          } else if (data.signal.candidate) {
            await pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
          }
        } catch (err) {
          showNotification("Failed to process signaling data");
        }
      });

      socket.on("update-name", ({ participantId, name }) => {
        if (participantId !== socket.id) {
          const oldName = state.participantNames.get(participantId) || "Anonymous";
          state.participantNames.set(participantId, sanitizeInput(name));
          state.typingUsers.delete(oldName);
          state.typingUsers.delete(sanitizeInput(name));
          const videoContainer = document.getElementById(`video-container-${participantId}`);
          if (videoContainer) {
            const nameLabel = videoContainer.querySelector(".participant-name");
            if (nameLabel) nameLabel.textContent = sanitizeInput(name);
          }
          updateParticipantList();
          renderChatMessages();
          showNotification(`${sanitizeInput(name)} updated their name`);
        }
      });

      socket.on("get-meeting-options", (options) => {
        state.meetingOptions = options || { lockMeeting: false, muteOnJoin: true, videoOffOnJoin: false };
        if (!state.isHost) {
          if (state.meetingOptions.muteOnJoin && state.isMicOn) {
            toggleMic();
            showNotification("Muted on join as per meeting settings");
          }
          if (state.meetingOptions.videoOffOnJoin && state.isCameraOn) {
            toggleCamera();
            showNotification("Video turned off on join as per meeting settings");
          }
        }
      });

      socket.on("apply-meeting-options", ({ lockMeeting, muteOnJoin, videoOffOnJoin }) => {
        state.meetingOptions = { lockMeeting, muteOnJoin, videoOffOnJoin };
        if (muteOnJoin && state.isMicOn) {
          toggleMic();
          showNotification("Muted due to meeting settings");
        }
        if (videoOffOnJoin && state.isCameraOn) {
          toggleCamera();
          showNotification("Video turned off due to meeting settings");
        }
        if (lockMeeting) {
          showNotification("Meeting is locked; no new participants can join");
        }
      });

      socket.on("update-meeting-options", ({ lockMeeting, muteOnJoin, videoOffOnJoin }) => {
        state.meetingOptions = { lockMeeting, muteOnJoin, videoOffOnJoin };
        showNotification("Meeting options updated by host");
        if (!state.isHost) {
          if (muteOnJoin && state.isMicOn) {
            toggleMic();
            showNotification("Muted due to meeting settings");
          }
          if (videoOffOnJoin && state.isCameraOn) {
            toggleCamera();
            showNotification("Video turned off due to meeting settings");
          }
          if (lockMeeting) {
            showNotification("Meeting is now locked");
          }
        }
      });

      socket.on("caption", ({ text, participantId }) => {
        if (state.isCaptionsOn) {
          const name = state.participantNames.get(participantId) || "Anonymous";
          displayCaption(text, name, false);
        }
      });

      socket.on("start-interpretation", ({ language, participantId }) => {
        showNotification(`${state.participantNames.get(participantId) || "A participant"} started interpretation for ${language.toUpperCase()}`);
      });

      socket.on("chat-message", ({ name, message, time }) => {
        addChatMessage(name, message, time);
      });

      socket.on("typing", ({ name }) => {
        state.typingUsers.add(sanitizeInput(name));
        if (state.activeTab === "chat") {
          renderChatMessages();
        }
      });

      socket.on("stop-typing", ({ name }) => {
        state.typingUsers.delete(sanitizeInput(name));
        if (state.activeTab === "chat") {
          renderChatMessages();
        }
      });

      socket.on("reaction", ({ name, emoji }) => {
        showReaction(emoji, name);
      });

      socket.on("end-meeting", () => {
        showNotification("The meeting has been ended by the host");
        cleanup();
        setTimeout(() => (window.location.href = "/"), 2000);
      });

      socket.on("toggle-hand", ({ participantId, raised }) => {
        if (participantId !== socket.id) {
          const stream = state.peerStreams.get(participantId);
          if (stream) stream.handRaised = raised;
          updateParticipantList();
          showNotification(
            `${state.participantNames.get(participantId) || "A participant"} ${raised ? "raised their hand" : "lowered their hand"}`
          );
        }
      });
    }

    socket.on("toggle-mic", ({ participantId, micOn }) => {
      if (participantId !== socket.id) {
        const stream = state.peerStreams.get(participantId);
        if (stream) {
          stream.getAudioTracks().forEach((track) => {
            track.enabled = micOn;
          });
          showNotification(
            `${sanitizeInput(state.participantNames.get(participantId) || "A participant")} ${micOn ? "unmuted" : "muted"} their microphone`
          );
        }
      }
    });

    socket.on("toggle-camera", ({ participantId, cameraOn }) => {
      if (participantId !== socket.id) {
        const stream = state.peerStreams.get(participantId);
        if (stream) {
          stream.getVideoTracks().forEach((track) => {
            track.enabled = cameraOn;
          });
          showNotification(
            `${sanitizeInput(state.participantNames.get(participantId) || "A participant")} ${cameraOn ? "turned on" : "turned off"} their camera`
          );
        }
      }
    });

    socket.on("screen-share", ({ sharing, participantId }) => {
      if (participantId !== socket.id) {
        if (sharing) {
          state.screenSharingParticipant = participantId;
          const stream = state.peerStreams.get(participantId);
          if (stream) {
            createVideoElement(participantId, state.participantNames.get(participantId) || "Anonymous", stream, false, true);
          }
          showNotification(`${sanitizeInput(state.participantNames.get(participantId) || "A participant")} started screen sharing`);
        } else {
          state.screenSharingParticipant = null;
          elements.screenShareOverlay.classList.add("hidden");
          const stream = state.peerStreams.get(participantId);
          if (stream) {
            createVideoElement(participantId, state.participantNames.get(participantId) || "Anonymous", stream, false, false);
          }
          showNotification(`${sanitizeInput(state.participantNames.get(participantId) || "A participant")} stopped screen sharing`);
        }
        updateParticipantList();
      }
    });

    socket.on("toggle-remote-mute", ({ participantId }) => {
      if (participantId === socket.id && state.isMicOn) {
        toggleMic();
        showNotification("You have been muted by the host");
      }
    });

    socket.on("toggle-remote-video", ({ participantId }) => {
      if (participantId === socket.id && state.isCameraOn) {
        toggleCamera();
        showNotification("Your video has been turned off by the host");
      }
    });

    socket.on("toggle-recording", ({ recording, participantId }) => {
      if (participantId !== socket.id) {
        state.isRecording = recording;
        elements.recordBtn.innerHTML = `<i class="fas fa-circle ${recording ? "text-red-500" : "text-gray-400"}"></i>`;
        showNotification(
          `${sanitizeInput(state.participantNames.get(participantId) || "A participant")} ${recording ? "started" : "stopped"} recording`
        );
      }
    });

    // Cleanup Participant
    function cleanupParticipant(peerId) {
      const pc = state.peers.get(peerId);
      if (pc) {
        pc.close();
        state.peers.delete(peerId);
      }

      state.peerStreams.delete(peerId);
      state.participantNames.delete(peerId);
      state.typingUsers.delete(sanitizeInput(state.participantNames.get(peerId) || "Anonymous"));

      const container = document.getElementById(`video-container-${peerId}`);
      if (container) container.remove();

      const participantElement = elements.participantsList.querySelector(`[data-id="${peerId}"]`);
      if (participantElement) participantElement.remove();

      if (state.focusedParticipant === peerId) {
        const remainingParticipants = Array.from(state.peers.keys()).concat("local");
        state.focusedParticipant = remainingParticipants.length > 0 ? remainingParticipants[0] : "local";
        setMainVideo(state.focusedParticipant);
      }

      updateParticipantCount();
      updateVideoGridLayout();
      renderChatMessages();
    }

    // Handle Window Resize
    function handleResize() {
      updateVideoGridLayout();
    }

    // Initialize on Load
    window.addEventListener("resize", handleResize);
    init();
  </script>
</body>

</html>